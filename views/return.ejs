<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Purchases</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
      }

      th {
        background-color: #f2f2f2;
      }
      .hide-column {
        display: none;
      }

    
    </style>
  </head>
  <body>
    <div class="navbar">
      <ul>
        <li><a href="/purchase">Purchase</a></li>
        <li><a href="/delivery">Delivery</a></li>
        <li><a href="/issue">Issue</a></li>
        <li><a href="/return">Return</a></li>
        <li><a href="/count">Count</a></li>
        <li><a href="/audit">Audit</a></li>
      </ul>
    </div>
    <h2>Return Receipt</h2>
    <p>Enter return details</p>
    <form
    id="purchaseForm"
    class="deleteMode"
    action="/return"
    method="post"
    onsubmit="handleSubmit(event)"
  >

    <div class="control-row">
      <label for="contractNumberDropDown">Contract Number:</label>
      <select id="contractNumberDropDown" name="contractNumberDropDown">
        <option disabled selected>Select a Contract Number</option>
        <% contractNumbers.forEach(contractNumbers => { %>
        <option value="<%= contractNumbers.ContractNumber %>">
          <%= contractNumbers.ContractNumber %>
        </option>
        <% }); %>
      </select>
    </div>

    <p class="form-actions">
      <button type="submit" class="button">Submit</button>
    </p>
  </form>
    <table id="purchaseTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Contract Number</th>
            <th>Panel Number</th>
            <th>Description</th>
            <th>Height</th>
            <th>Width</th>
            <th>Length</th>
            <th>Qty Issued</th>
            <th>Issue Date</th>
          </tr>
        </thead>
        <tbody></tbody>
        <!-- Empty tbody for dynamically populated rows -->
      </table>
      <form
      id="purchaseForm"
      class="deleteMode"
      action="/return"
      method="post"
      onsubmit="handleReturn(event)"
    >
      <h2>Purchase Order</h2>
      <p>Enter purchase details</p>


      <div class="control-row">
        <label for="idDropdown">ID:</label>
        <select id="idDropdown" name="idDropdown">          
          <option disabled selected>Select ID</option>
        </select>        
      </div>

      <div class="control">
        <label for="contractNumber">Contract Number:</label>
        <label id="contractNumberLblInput"></label>
      </div>



      <div class="control-row">
        <label for="panelLbl">Panel:</label>
        <label id="panelLblInput">Panel:</label>
        
      </div>

      <div class="control-row">
        <label for="descriptionLbl">Description:</label>
        <label id="descriptionLblInput">Description:</label>        

      </div>

      <div class="control">
        <label for="heightLbl">Height:</label>
        <label id="heightLblInput">Height:</label>
      </div>

      <div class="control">
        <label for="widthLbl">Width:</label>
        <label id="widthLblInput">Width:</label>

      </div>
      <div class="control">
        <label for="length">Length:</label>
        <input id="length" name="length" required />
      </div>

      <div class="control">
        <label for="returnQty">Return Quantity:</label>
        <input id="returnQty" name="returnQty" required />
      </div>

      <p class="form-actions">
        <button type="reset" class="button button-flat">Reset</button>
        <button type="submit"  class="button">Submit</button>
      </p>
    </form>

      <script>
let insertData=[];        

function handleReturn(event) {
  event.preventDefault(); 

  let sendingData=[];

    // Extract necessary data from the row
    const contractNumber = insertData[0].ContractNumber;
    const description = insertData[0].Description; 
    const panelNumber=insertData[0].Panel;
    const height = insertData[0].Height; 
    const width = insertData[0].Width; 
    const length = document.getElementById("length").value;
    const qty = document.getElementById("returnQty").value;

    // Add data to insertData array
    sendingData.push({ contractNumber, panelNumber, description, height, width, length, qty });
  


// console.log("Data to be inserted:", insertData); // Debugging line

// Send insertData to the server
fetch("/return/insertReturnTransaction", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ sendingData })
})
.then(response => {
  if (!response.ok) {
    throw new Error("Network response was not ok");
  }
  return response.json();
})
.then(data => {
  console.log(data); // Handle response from server if needed
})
.catch(error => {
  console.error("Error inserting data:", error);
});
};

function populateData(data) {
  document.getElementById('contractNumberLblInput').textContent = data.ContractNumber;
  document.getElementById('panelLblInput').textContent = data.Panel;
  document.getElementById('descriptionLblInput').textContent = data.Description;
  document.getElementById('heightLblInput').textContent = data.Height;
  document.getElementById('widthLblInput').textContent = data.Width;
  // Assuming you want to set the value of the length input field
  document.getElementById('length').value = data.Length;
}

   // Define the function to handle the selection change
  function handleSelectionChange(selectedValue) {
    // console.log("Selected value:", selectedValue);
    // Add your logic here
    fetch(`/return/id/${selectedValue}`)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then((data) => {
      populateData(data[0]);
      insertData.push(data[0]);
      console.log(insertData);

      // populateTable(data);TODO
    })
    .catch((error) => {
      console.error("Error fetching purchases:", error);
    });
  }

  // Attach the change event listener to the dropdown
  document.getElementById('idDropdown').addEventListener('change', function() {
    const selectedValue = this.value;
    handleSelectionChange(selectedValue);
  });
 
function handleSubmit(event) {
  event.preventDefault();
  qtyInStock=[];
  const selectedContractNumber = document.getElementById("contractNumberDropDown").value;



  fetch(`/return/transactions/${selectedContractNumber}`)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then((data) => {
      populateTable(data);
    })
    .catch((error) => {
      console.error("Error fetching purchases:", error);
    });
}

function populateTable(purchases) {
  const tableBody = document.querySelector("#purchaseTable tbody");
  tableBody.innerHTML = ""; // Clear existing table body

  if (purchases.length === 0) {
    // Handle case where no purchases are returned
    const row = document.createElement("tr");
    const cell = document.createElement("td");
    cell.colSpan = "13"; // Span across all columns
    cell.textContent = "No purchases found.";
    row.appendChild(cell);
    tableBody.appendChild(row);
    return;
  }

  const idDropdown = document.getElementById('idDropdown');
  purchases.forEach((purchase) => {
    const row = document.createElement("tr");
    row.setAttribute("data-id", purchase.ID); // Add data-id attribute for identifying the row
    const cells = [
      purchase.ID,
      purchase.ContractNumber,
      purchase.Panel,
      purchase.Description,
      purchase.Height,
      purchase.Width,
      purchase.Length,
      purchase.Qty,
      purchase.DateOfTransaction,
    ];
    const option = document.createElement('option');
    option.value = purchase.ID;
    option.textContent = purchase.ID;
    idDropdown.appendChild(option);

    cells.forEach((cellData, i) => {
  const cell = document.createElement("td");
    cell.textContent = cellData;
  
  row.appendChild(cell);
});

    tableBody.appendChild(row);
  });
}
      </script>
  </body>
</html>